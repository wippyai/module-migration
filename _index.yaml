version: "1.0"
namespace: wippy.migration

entries:
  # Requirements
  - name: app_db
    kind: ns.requirement
    meta:
      description: "Application database ID for migrations"
    targets:
      - entry: wippy.migration:migration_bootloader
        path: ".meta.requires +="
    default: "app:db"

  # Dependencies
  - name: __dependency.wippy.bootloader
    kind: "ns.dependency"
    meta:
      description: "Bootloader component for orchestration"
    component: "wippy/bootloader"
    version: ">=v0.3.0"

  # wippy.migration:core
  - name: core
    kind: library.lua
    meta:
      comment: Core DSL for migration definitions
    source: file://core.lua

  # wippy.migration:migration
  - name: migration
    kind: library.lua
    meta:
      comment: Main migration library API
    source: file://migration.lua
    modules:
      - time
      - json
    imports:
      core: wippy.migration:core
      repository: wippy.migration:repository

  # wippy.migration:registry
  - name: registry
    kind: library.lua
    meta:
      comment: Registry queries for migrations
    source: file://registry.lua
    modules:
      - time
    imports:
      base_registry: :registry

  # wippy.migration:repository
  - name: repository
    kind: library.lua
    meta:
      comment: Migration repository (in-db) for tracking applied migrations
    source: file://repository.lua
    modules:
      - sql
      - json

  # wippy.migration:runner
  - name: runner
    kind: library.lua
    meta:
      comment: Main migration library API
    source: file://runner.lua
    modules:
      - time
      - funcs
    imports:
      registry: wippy.migration:registry
      repository: wippy.migration:repository

  # wippy.migration:migration_bootloader
  - name: migration_bootloader
    kind: function.lua
    meta:
      type: bootloader
      order: 20
      description: Run database migrations for all targets
      requires:
        - wippy.bootloader.bootloaders:encryption_key
    source: file://migration_bootloader.lua
    modules:
      - time
      - sql
      - logger
    imports:
      migration_registry: wippy.migration:registry
      runner: wippy.migration:runner
    method: run
